<%= form_with model: [:admin, @work], local: true do |f| %>
  <% if @work.errors.any? %>
    <div class="alert alert-danger">
      <h4>Erreurs détectées :</h4>
      <ul>
        <% @work.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <!-- Colonne principale -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header">
          <h3>Informations principales</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :title, "Titre du projet", class: "form-label" %>
            <%= f.text_field :title, class: "form-control",
                placeholder: "Ex: Application IzyChef", required: true %>
          </div>

          <div class="mb-3">
            <%= f.label :client, "Client", class: "form-label" %>
            <%= f.text_field :client, class: "form-control",
                placeholder: "Ex: Solution SaaS", required: true %>
          </div>

          <div class="mb-3">
            <%= f.label :description, "Description", class: "form-label" %>
            <%= f.text_area :description, class: "form-control", rows: 5,
                placeholder: "Description détaillée du projet..." %>
          </div>

          <div class="row">
            <div class="col-md-6">
              <%= f.label :start_date, "Date de début", class: "form-label" %>
              <%= f.date_field :start_date, class: "form-control" %>
            </div>
            <div class="col-md-6">
              <%= f.label :end_date, "Date de fin", class: "form-label" %>
              <%= f.date_field :end_date, class: "form-control" %>
            </div>
          </div>
        </div>
      </div>

      <!-- Technologies -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>Technologies utilisées</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :technologies, class: "form-label" %>
            <div id="technologies-container">
              <% (f.object.technologies || []).each do |tech| %>
                <div class="input-group mb-2">
                  <input type="text" name="work[technologies][]"
                         value="<%= tech %>" class="form-control">
                  <button type="button" class="btn btn-outline-danger btn-remove-tech">
                    Supprimer
                  </button>
                </div>
              <% end %>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm" id="add-technology">
              + Ajouter une technologie
            </button>
          </div>
        </div>
      </div>

      <!-- Images -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>Images du projet</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :images, "Ajouter des images", class: "form-label" %>
            <%= f.file_field :images, multiple: true, class: "form-control",
                accept: "image/*" %>
            <small class="text-muted">
              Formats acceptés : JPG, PNG, GIF. Taille max : 5MB par image.
            </small>
          </div>

          <% if @work.images.attached? %>
            <div class="row mt-3">
              <% @work.images.each do |image| %>
                <div class="col-md-3 mb-3">
                  <div class="card">
                    <%= image_tag image.variant(resize_to_fill: [200, 150]),
                        class: "card-img-top" %>
                    <div class="card-body p-2">
                      <%= link_to "Supprimer",
                          delete_image_admin_work_path(@work, image_id: image.id),
                          method: :delete,
                          data: { confirm: "Supprimer cette image ?" },
                          class: "btn btn-sm btn-danger w-100" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Colonne latérale -->
    <div class="col-md-4">
      <!-- Paramètres -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>Paramètres</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :number, "Numéro", class: "form-label" %>
            <%= f.text_field :number, class: "form-control",
                placeholder: "001", pattern: "\\d{3}", required: true %>
            <small class="text-muted">Format : 3 chiffres (ex: 001)</small>
          </div>

          <div class="mb-3">
            <%= f.label :slug, "URL (slug)", class: "form-label" %>
            <%= f.text_field :slug, class: "form-control",
                placeholder: "Généré automatiquement" %>
            <small class="text-muted">
              Laissez vide pour générer automatiquement
            </small>
          </div>

          <div class="mb-3">
            <%= f.label :category, "Catégorie", class: "form-label" %>
            <%= f.select :category,
                options_for_select([
                  ['Web', 'web'],
                  ['Mobile', 'mobile'],
                  ['Design', 'design'],
                  ['Automation', 'automation'],
                  ['Autre', 'other']
                ], f.object.category),
                {}, class: "form-select" %>
          </div>

          <div class="mb-3">
            <%= f.label :status, "Statut", class: "form-label" %>
            <%= f.select :status,
                options_for_select([
                  ['Terminé', 'completed'],
                  ['En cours', 'in_progress']
                ], f.object.status),
                {}, class: "form-select" %>
          </div>

          <div class="form-check mb-3">
            <%= f.check_box :featured, class: "form-check-input" %>
            <%= f.label :featured, "Mettre en vedette", class: "form-check-label" %>
          </div>
        </div>
      </div>

      <!-- Liens -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>Liens</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :github_url, "GitHub", class: "form-label" %>
            <%= f.text_field :github_url, class: "form-control",
                placeholder: "https://github.com/..." %>
          </div>

          <div class="mb-3">
            <%= f.label :live_url, "URL Live", class: "form-label" %>
            <%= f.text_field :live_url, class: "form-control",
                placeholder: "https://..." %>
          </div>
        </div>
      </div>

      <!-- SEO -->
      <div class="card">
        <div class="card-header">
          <h3>SEO</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :meta_description, "Meta Description", class: "form-label" %>
            <%= f.text_area :meta_description, class: "form-control", rows: 3,
                placeholder: "Description pour les moteurs de recherche (max 160 caractères)" %>
            <small class="text-muted">
              <span id="meta-description-count">0</span> / 160 caractères
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="card">
    <div class="card-body d-flex justify-content-between">
      <%= link_to "Annuler", admin_works_path, class: "btn btn-secondary" %>
      <div>
        <%= f.submit "Enregistrer comme brouillon",
            name: "draft", class: "btn btn-outline-primary me-2" %>
        <%= f.submit "Enregistrer et publier", class: "btn btn-primary" %>
      </div>
    </div>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Ajouter technologie
    document.getElementById('add-technology')?.addEventListener('click', () => {
      const container = document.getElementById('technologies-container');
      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input type="text" name="work[technologies][]" class="form-control" placeholder="Ex: Ruby on Rails">
        <button type="button" class="btn btn-outline-danger btn-remove-tech">Supprimer</button>
      `;
      container.appendChild(div);
    });

    // Supprimer technologie
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('btn-remove-tech')) {
        e.target.closest('.input-group').remove();
      }
    });

    // Compteur meta description
    const metaDesc = document.querySelector('[name="work[meta_description]"]');
    const counter = document.getElementById('meta-description-count');
    if (metaDesc && counter) {
      const updateCount = () => {
        counter.textContent = metaDesc.value.length;
        counter.style.color = metaDesc.value.length > 160 ? 'red' : 'inherit';
      };
      metaDesc.addEventListener('input', updateCount);
      updateCount();
    }
  });
</script>
